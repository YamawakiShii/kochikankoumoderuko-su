<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>高知1日モデルコースメーカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --accent: #f97316;
      --radius: 12px;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 45%, #f9fafb 100%);
      color: var(--text-main);
    }
    header { padding: 24px 20px 8px; text-align: center; }
    header h1 { margin: 0; font-size: 1.8rem; }
    header p { margin: 8px 0 0; color: var(--text-sub); font-size: 0.95rem; }
    main {
      max-width: 1100px;
      margin: 0 auto 40px;
      padding: 0 16px 32px;
      display: grid;
      grid-template-columns: 1.05fr 1.35fr;
      gap: 20px;
    }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .card h2 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(20, 184, 166, 0.08);
      color: var(--primary);
      font-size: 0.7rem;
      font-weight: 600;
    }
    label { display: block; margin: 12px 0 4px; font-size: 0.9rem; font-weight: 600; }
    select, input[type="time"], input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      background: #f9fafb;
    }
    .inline-group { display: flex; gap: 10px; }
    .inline-group > div { flex: 1; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      cursor: pointer;
      background: #f9fafb;
      color: var(--text-sub);
      transition: all 0.15s ease;
      user-select: none;
    }
    .chip.active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }
    button {
      margin-top: 16px;
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #ffffff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(15, 118, 110, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(15, 118, 110, 0.4);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(15, 118, 110, 0.3);
    }
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }
    .result-meta { font-size: 0.8rem; color: var(--text-sub); text-align: right; }
    .timeline {
      margin-top: 8px;
      border-left: 2px solid rgba(148, 163, 184, 0.6);
      padding-left: 12px;
    }
    .slot { position: relative; margin-bottom: 14px; padding-left: 4px; }
    .slot::before {
      content: "";
      position: absolute;
      left: -14px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 2px solid var(--primary);
    }
    .slot-time { font-size: 0.8rem; color: var(--primary); font-weight: 600; }
    .slot-title { font-size: 0.95rem; font-weight: 600; margin-top: 2px; }
    .slot-detail { font-size: 0.8rem; color: var(--text-sub); margin-top: 2px; }
    .tag-row { margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px; }
    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.08);
      color: var(--primary);
    }
    .empty-state { font-size: 0.85rem; color: var(--text-sub); margin-top: 8px; }
    .footer-note {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--text-sub);
      border-top: 1px dashed var(--border);
      padding-top: 8px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(249, 115, 22, 0.08);
      color: var(--accent);
      font-size: 0.7rem;
      font-weight: 600;
    }
    #map {
      margin-top: 12px;
      width: 100%;
      height: 260px;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .marker-number {
      background: #ef4444;
      color: #fff;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      border: 2px solid #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <header>
    <h1>高知1日モデルコースメーカー</h1>
    <p>気分と時間を選ぶだけで、高知の1日旅プランを自動生成。</p>
  </header>

  <main>
    <!-- 左：条件入力 -->
    <section class="card">
      <h2>条件をえらぶ <span class="badge">STEP 1</span></h2>

      <label for="date">日付（任意）</label>
      <input type="date" id="date" />
      <div class="empty-state">日曜市は日曜日のみ候補に入ります。</div>

      <div class="inline-group">
        <div>
          <label for="startTime">スタート時間</label>
          <input type="time" id="startTime" value="09:00" />
        </div>
        <div>
          <label for="endTime">終了時間</label>
          <input type="time" id="endTime" value="18:00" />
        </div>
      </div>

      <label>テーマ（複数選択可）</label>
      <div class="chips" id="themeChips">
        <div class="chip" data-value="food">食を楽しむ</div>
        <div class="chip" data-value="history">歴史・文化</div>
        <div class="chip" data-value="nature">自然・海・山</div>
        <div class="chip" data-value="relax">まったり</div>
        <div class="chip" data-value="local">ローカル感</div>
      </div>

      <label>移動手段</label>
      <div class="chips" id="transportChips">
        <div class="chip active" data-value="walk">徒歩＋路面電車中心</div>
        <div class="chip" data-value="car">車あり</div>
      </div>

      <label for="vibe">旅のテンション</label>
      <select id="vibe">
        <option value="standard">バランスよく楽しみたい</option>
        <option value="slow">ゆっくり少なめで</option>
        <option value="dense">ぎゅっと詰め込みたい</option>
      </select>

      <button id="generateBtn">
        この条件でモデルコースをつくる ✨
      </button>
    </section>

    <!-- 右：結果表示 -->
    <section class="card">
      <div class="result-header">
        <h2>今日の高知プラン <span class="badge">STEP 2</span></h2>
        <div class="result-meta" id="resultMeta">条件を入力して「つくる」を押してください。</div>
      </div>

      <div id="timelineContainer">
        <p class="empty-state">
          ひろめ市場でカツオを食べる？ 高知城で歴史に浸る？ 桂浜で海を眺める？<br />
          あなたの「今日の気分」に合わせて、1日コースを自動で組み立てます。
        </p>
      </div>

      <div id="map"></div>

      <div class="footer-note">
        <span class="pill">NOTE</span>
        表示されるコースはあくまでモデルです。実際の営業時間・交通状況は公式情報をご確認ください。
      </div>
    </section>
  </main>

  <script>
    // --- スポットデータ（緯度・経度付き） ---
    const spots = [
      {
        id: "kochi-castle",
        name: "高知城・高知城歴史博物館",
        tags: ["history", "local"],
        area: "中心部",
        typicalStayMin: 90,
        lat: 33.5593,
        lng: 133.5311,
        description: "天守から高知市内を一望。歴史博物館とセットで楽しめる。",
      },
      {
        id: "hirome",
        name: "ひろめ市場",
        tags: ["food", "local"],
        area: "中心部",
        typicalStayMin: 60,
        lat: 33.5590,
        lng: 133.5319,
        description: "カツオのたたきやご当地グルメが集まる人気スポット。",
      },
      {
        id: "sunday-market",
        name: "日曜市",
        tags: ["local", "food"],
        area: "中心部",
        typicalStayMin: 60,
        lat: 33.5595,
        lng: 133.5310,
        description: "約1km続く青空市。野菜・果物・田舎寿司など。",
        onlySunday: true,
      },
      {
        id: "harimaya",
        name: "はりまや橋・商店街",
        tags: ["local", "history"],
        area: "中心部",
        typicalStayMin: 30,
        lat: 33.5598,
        lng: 133.5410,
        description: "高知の象徴的スポット。周辺の商店街も散策に最適。",
      },
      {
        id: "cafe",
        name: "まったりカフェタイム（中心部）",
        tags: ["relax", "local"],
        area: "中心部",
        typicalStayMin: 60,
        lat: 33.5592,
        lng: 133.5350,
        description: "喫茶文化が根付く高知でゆっくり休憩。",
      },
      {
        id: "makino",
        name: "高知県立牧野植物園",
        tags: ["nature", "relax"],
        area: "五台山",
        typicalStayMin: 120,
        lat: 33.5598,
        lng: 133.5564,
        description: "牧野富太郎ゆかりの植物園。四季の花が美しい。",
      },
      {
        id: "godaisan-temple",
        name: "竹林寺（五台山）",
        tags: ["history", "relax"],
        area: "五台山",
        typicalStayMin: 60,
        lat: 33.5587,
        lng: 133.5550,
        description: "四国霊場31番札所。静かな時間を過ごせる寺院。",
      },
      {
        id: "godaisan-view",
        name: "五台山展望台",
        tags: ["nature", "relax"],
        area: "五台山",
        typicalStayMin: 30,
        lat: 33.5608,
        lng: 133.5575,
        description: "高知市街を一望できる絶景スポット。",
      },
      {
        id: "katsurahama",
        name: "桂浜・坂本龍馬像",
        tags: ["nature", "history"],
        area: "桂浜",
        typicalStayMin: 120,
        lat: 33.4964,
        lng: 133.5730,
        description: "太平洋を望む景勝地。龍馬像も人気。",
      },
      {
        id: "ryoma-museum",
        name: "高知県立坂本龍馬記念館",
        tags: ["history"],
        area: "桂浜",
        typicalStayMin: 90,
        lat: 33.4978,
        lng: 133.5745,
        description: "龍馬の生涯と幕末史を深く学べる博物館。",
      },
      {
        id: "katsurahama-aquarium",
        name: "桂浜水族館",
        tags: ["nature", "local"],
        area: "桂浜",
        typicalStayMin: 60,
        lat: 33.4955,
        lng: 133.5735,
        description: "ローカル感あふれる水族館。動物との距離が近い。",
      },
      {
        id: "asakura",
        name: "朝倉エリア散策（大学周辺）",
        tags: ["local", "relax"],
        area: "郊外",
        typicalStayMin: 60,
        lat: 33.5535,
        lng: 133.5030,
        description: "学生街のカフェや書店が点在する落ち着いたエリア。",
      },
      {
        id: "inari",
        name: "秦神社・稲荷神社",
        tags: ["history", "local"],
        area: "郊外",
        typicalStayMin: 40,
        lat: 33.5530,
        lng: 133.5150,
        description: "地元に愛される神社で静かな時間を。",
      },
      {
        id: "tosanosato",
        name: "とさのさと（産直市場）",
        tags: ["food", "local"],
        area: "郊外",
        typicalStayMin: 45,
        lat: 33.5655,
        lng: 133.5465,
        description: "新鮮な野菜や特産品が揃う大型産直。",
      },
      {
        id: "ryugado",
        name: "龍河洞（香美市）",
        tags: ["nature", "history"],
        area: "遠方",
        typicalStayMin: 120,
        lat: 33.6120,
        lng: 133.7020,
        description: "日本三大鍾乳洞のひとつ。探検気分を味わえる。",
      },
      {
        id: "anpanman",
        name: "アンパンマンミュージアム（香美市）",
        tags: ["local", "relax"],
        area: "遠方",
        typicalStayMin: 120,
        lat: 33.5675,
        lng: 133.7025,
        description: "やなせたかしの世界を楽しめるミュージアム。",
      },
      {
        id: "niyodo",
        name: "仁淀川ブルー（いの町）",
        tags: ["nature"],
        area: "遠方",
        typicalStayMin: 120,
        lat: 33.5650,
        lng: 133.3550,
        description: "透明度抜群の清流。川辺散策や写真撮影に最適。",
      },
      {
        id: "tosayama",
        name: "土佐山アクティビティ（温泉・カフェ）",
        tags: ["nature", "relax"],
        area: "遠方",
        typicalStayMin: 120,
        lat: 33.6060,
        lng: 133.4450,
        description: "山間の静かなエリアで自然と温泉を楽しめる。",
      },
    ];

    // --- エリア間の移動時間（分） ---
    const travelTimeMatrix = {
      "中心部": { "中心部": 10, "五台山": 20, "桂浜": 35, "郊外": 20, "遠方": 50 },
      "五台山": { "中心部": 20, "五台山": 10, "桂浜": 25, "郊外": 30, "遠方": 60 },
      "桂浜": { "中心部": 35, "五台山": 25, "桂浜": 10, "郊外": 40, "遠方": 70 },
      "郊外": { "中心部": 20, "五台山": 30, "桂浜": 40, "郊外": 10, "遠方": 50 },
      "遠方": { "中心部": 50, "五台山": 60, "桂浜": 70, "郊外": 50, "遠方": 20 },
    };

    // --- ユーティリティ ---
    function parseTimeToMinutes(timeStr) {
      const [h, m] = timeStr.split(":").map(Number);
      return h * 60 + m;
    }
    function minutesToTimeStr(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
    }
    function isSunday(dateStr) {
      if (!dateStr) return false;
      const d = new Date(dateStr);
      return d.getDay() === 0;
    }

    // --- UI要素 ---
    const themeChips = document.getElementById("themeChips");
    const transportChips = document.getElementById("transportChips");
    const generateBtn = document.getElementById("generateBtn");
    const resultMeta = document.getElementById("resultMeta");
    const timelineContainer = document.getElementById("timelineContainer");

    themeChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      chip.classList.toggle("active");
    });

    transportChips.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      [...transportChips.querySelectorAll(".chip")].forEach((c) =>
        c.classList.remove("active")
      );
      chip.classList.add("active");
    });

    // --- Leaflet 地図初期化 ---
    let map = L.map("map").setView([33.5593, 133.5311], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);
    let markerLayer = L.layerGroup().addTo(map);

    function clearMarkers() {
      markerLayer.clearLayers();
    }

    function addNumberedMarkers(timeline) {
      clearMarkers();
      if (!timeline.length) return;

      const bounds = [];
      timeline.forEach((t, index) => {
        const num = index + 1;
        const icon = L.divIcon({
          className: "",
          html: `<div class="marker-number">${num}</div>`,
          iconSize: [26, 26],
          iconAnchor: [13, 13],
        });

        const marker = L.marker([t.spot.lat, t.spot.lng], { icon }).addTo(markerLayer);

        const gmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${t.spot.lat},${t.spot.lng}`;
        const popupHtml = `
          <strong>${num}. ${t.spot.name}</strong><br/>
          ${t.spot.description}<br/>
          滞在目安：${t.spot.typicalStayMin}分<br/>
          <a href="${gmapUrl}" target="_blank">現在地からのルートを見る（Googleマップ）</a>
        `;
        marker.bindPopup(popupHtml);

        bounds.push([t.spot.lat, t.spot.lng]);
      });

      if (bounds.length === 1) {
        map.setView(bounds[0], 14);
      } else {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    // --- コース生成ロジック ---
    function generateCourse() {
      const date = document.getElementById("date").value;
      const startTime = document.getElementById("startTime").value || "09:00";
      const endTime = document.getElementById("endTime").value || "18:00";
      const vibe = document.getElementById("vibe").value;

      const selectedThemes = [
        ...themeChips.querySelectorAll(".chip.active"),
      ].map((c) => c.dataset.value);

      const transport =
        transportChips.querySelector(".chip.active")?.dataset.value || "walk";

      const startMin = parseTimeToMinutes(startTime);
      const endMin = parseTimeToMinutes(endTime);
      const totalAvailable = Math.max(endMin - startMin, 0);

      if (totalAvailable < 120) {
        timelineContainer.innerHTML =
          '<p class="empty-state">2時間未満だと、少しタイトかもしれません。時間を少し伸ばしてみてください。</p>';
        resultMeta.textContent = "時間が短すぎます。";
        clearMarkers();
        return;
      }

      const sunday = isSunday(date);
      const candidateSpots = spots.filter((s) => {
        if (s.onlySunday && !sunday) return false;
        if (transport === "walk" && s.area === "遠方") return false;
        return true;
      });

      const scored = candidateSpots
        .map((s) => {
          let score = 0;
          if (selectedThemes.length === 0) {
            score = 1;
          } else {
            s.tags.forEach((t) => {
              if (selectedThemes.includes(t)) score += 1;
            });
          }
          if (s.tags.includes("local")) score += 0.3;
          return { spot: s, score };
        })
        .filter((s) => s.score > 0)
        .sort((a, b) => b.score - a.score);

      if (scored.length === 0) {
        timelineContainer.innerHTML =
          '<p class="empty-state">この条件では候補が見つかりませんでした。テーマを増やすか、日付・移動手段を変えてみてください。</p>';
        resultMeta.textContent = "候補スポットなし";
        clearMarkers();
        return;
      }

      let targetMinutes;
      if (vibe === "slow") {
        targetMinutes = totalAvailable * 0.5;
      } else if (vibe === "dense") {
        targetMinutes = totalAvailable * 0.9;
      } else {
        targetMinutes = totalAvailable * 0.7;
      }

      const selected = [];
      let usedMinutes = 0;

      for (const { spot } of scored) {
        const stay = spot.typicalStayMin;
        if (usedMinutes + stay > targetMinutes + 45) continue;
        selected.push(spot);
        usedMinutes += stay;
      }

      if (selected.length === 0) {
        selected.push(scored[0].spot);
        usedMinutes = scored[0].spot.typicalStayMin;
      }

      const timeline = [];
      let current = startMin;

      selected.forEach((spot, index) => {
        let moveMin = 0;
        if (index > 0) {
          const prev = selected[index - 1];
          moveMin = travelTimeMatrix[prev.area][spot.area] || 15;
        }
        const start = current + moveMin;
        const end = Math.min(start + spot.typicalStayMin, endMin);
        timeline.push({ spot, start, end, moveMin });
        current = end;
      });

      renderTimeline(timeline, { date, startTime, endTime, vibe, transport, sunday });
      addNumberedMarkers(timeline);
    }

    function renderTimeline(timeline, meta) {
      if (!timeline.length) {
        timelineContainer.innerHTML =
          '<p class="empty-state">コースが生成できませんでした。</p>';
        resultMeta.textContent = "";
        return;
      }

      const totalStay = timeline.reduce(
        (sum, t) => sum + (t.end - t.start),
        0
      );
      const hours = (totalStay / 60).toFixed(1);

      const vibeLabel =
        meta.vibe === "slow"
          ? "ゆっくりめ"
          : meta.vibe === "dense"
          ? "しっかり観光"
          : "バランス型";

      resultMeta.textContent = `滞在目安：約${hours}時間 / テンション：${vibeLabel}`;

      const html = [
        '<div class="timeline">',
        ...timeline.map((t, idx) => {
          const tagsHtml = t.spot.tags
            .map((tag) => `<span class="tag">#${tag}</span>`)
            .join("");
          const timeStr = `${minutesToTimeStr(t.start)}〜${minutesToTimeStr(
            t.end
          )}`;
          const moveHtml =
            t.moveMin > 0
              ? `<div class="slot-detail">移動：${t.moveMin}分</div>`
              : "";
          const gmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${t.spot.lat},${t.spot.lng}`;
          return `
            <div class="slot">
              <div class="slot-time">${timeStr}</div>
              <div class="slot-title">${idx + 1}. ${t.spot.name}</div>
              ${moveHtml}
              <div class="slot-detail">${t.spot.description}</div>
              <div class="slot-detail">
                <a href="${gmapUrl}" target="_blank">現在地からのルートを見る（Googleマップ）</a>
              </div>
              <div class="tag-row">${tagsHtml}</div>
            </div>
          `;
        }),
        "</div>",
      ].join("");

      timelineContainer.innerHTML = html;
    }

    generateBtn.addEventListener("click", generateCourse);
  </script>
</body>
</html>
