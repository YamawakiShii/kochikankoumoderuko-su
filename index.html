<head>
  <meta charset="UTF-8" />
  <title>高知1日モデルコースメーカー（完全版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- SortableJS（ドラッグ並び替え） -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --bg: #f9fafb;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --accent: #f97316;
      --radius: 12px;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 45%, #f9fafb 100%);
      color: var(--text-main);
    }

    header {
      padding: 24px 20px 8px;
      text-align: center;
    }

    main {
      max-width: 1100px;
      margin: 0 auto 40px;
      padding: 0 16px 32px;
      display: grid;
      grid-template-columns: 1.05fr 1.35fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    /* 折り畳み候補リスト */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 10px 0;
      font-weight: 600;
      font-size: 1rem;
    }

    .collapsible-content {
      display: none;
      margin-top: 10px;
    }

    .spot-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .spot-add-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    /* 検索バー */
    .search-box {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    /* 地図 */
    #map {
      margin-top: 12px;
      width: 100%;
      height: 260px;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    /* 番号付きピン */
    .marker-number {
      background: #ef4444;
      color: #fff;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      border: 2px solid #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    /* 追加モードボタン */
    .add-mode-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* 現在地ボタン */
    .locate-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* タイムライン（Sortable対応） */
    .timeline {
      border-left: 2px solid rgba(148, 163, 184, 0.6);
      padding-left: 12px;
      margin-top: 8px;
    }

    .slot {
      position: relative;
      margin-bottom: 14px;
      padding-left: 4px;
      background: #f9fafb;
      border-radius: 8px;
      padding: 10px;
    }

    .slot::before {
      content: "";
      position: absolute;
      left: -14px;
      top: 14px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 2px solid var(--primary);
    }

    .slot-delete {
      color: #ef4444;
      font-size: 0.8rem;
      cursor: pointer;
      margin-top: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <header>
    <h1>高知1日モデルコースメーカー（完全版）</h1>
    <p>気分と時間を選ぶだけで、高知の1日旅プランを自動生成＋自由編集。</p>
  </header>

  <main>
    <!-- 左：条件入力＋候補リスト -->
    <section class="card">
      <h2>条件をえらぶ <span class="badge">STEP 1</span></h2>

      <label for="date">日付（任意）</label>
      <input type="date" id="date" />
      <div class="empty-state">日曜市は日曜日のみ候補に入ります。</div>

      <div class="inline-group">
        <div>
          <label for="startTime">スタート時間</label>
          <input type="time" id="startTime" value="09:00" />
        </div>
        <div>
          <label for="endTime">終了時間</label>
          <input type="time" id="endTime" value="18:00" />
        </div>
      </div>

      <label>テーマ（複数選択可）</label>
      <div class="chips" id="themeChips">
        <div class="chip" data-value="food">食を楽しむ</div>
        <div class="chip" data-value="history">歴史・文化</div>
        <div class="chip" data-value="nature">自然・海・山</div>
        <div class="chip" data-value="relax">まったり</div>
        <div class="chip" data-value="local">ローカル感</div>
      </div>

      <label>移動手段</label>
      <div class="chips" id="transportChips">
        <div class="chip active" data-value="walk">徒歩＋路面電車中心</div>
        <div class="chip" data-value="car">車あり</div>
      </div>

      <label for="vibe">旅のテンション</label>
      <select id="vibe">
        <option value="standard">バランスよく楽しみたい</option>
        <option value="slow">ゆっくり少なめで</option>
        <option value="dense">ぎゅっと詰め込みたい</option>
      </select>

      <button id="generateBtn">
        この条件でモデルコースをつくる ✨
      </button>

      <!-- ▼ 折り畳み候補リスト -->
      <div class="collapsible-header" id="candidateToggle">
        <span>▶ スポット候補一覧</span>
        <span id="candidateCount"></span>
      </div>

      <div class="collapsible-content" id="candidateList">
        <input
          type="text"
          id="candidateSearch"
          class="search-box"
          placeholder="スポット名で検索"
        />

        <div id="candidateItems"></div>
      </div>
    </section>

    <!-- 右：結果表示＋地図 -->
    <section class="card">
      <div class="result-header">
        <h2>今日の高知プラン <span class="badge">STEP 2</span></h2>
        <div class="result-meta" id="resultMeta">
          条件を入力して「つくる」を押してください。
        </div>
      </div>

      <div id="timelineContainer">
        <p class="empty-state">
          ひろめ市場でカツオを食べる？ 高知城で歴史に浸る？ 桂浜で海を眺める？<br />
          あなたの「今日の気分」に合わせて、1日コースを自動で組み立てます。
        </p>
      </div>

      <!-- 並び替え可能なタイムライン -->
      <div id="sortableTimeline" class="timeline"></div>

      <!-- 地図 -->
      <div id="map"></div>

      <!-- 追加モード -->
      <button class="add-mode-btn" id="addModeBtn">追加モード：OFF</button>

      <!-- 現在地表示 -->
      <button class="locate-btn" id="locateBtn">現在地を表示</button>

      <div class="footer-note">
        <span class="pill">NOTE</span>
        表示されるコースはあくまでモデルです。実際の営業時間・交通状況は公式情報をご確認ください。
      </div>
    </section>
  </main>
</body>
<script>
/* =========================================================
   スポットデータ（営業時間・混雑時間帯・カテゴリ追加）
   ========================================================= */
const spots = [
  {
    id: "kochi-castle",
    name: "高知城・高知城歴史博物館",
    tags: ["history", "local"],
    area: "中心部",
    typicalStayMin: 90,
    lat: 33.5593,
    lng: 133.5311,
    description: "天守から高知市内を一望。歴史博物館とセットで楽しめる。",
    open: "09:00",
    close: "17:00",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "hirome",
    name: "ひろめ市場",
    tags: ["food", "local"],
    area: "中心部",
    typicalStayMin: 60,
    lat: 33.5590,
    lng: 133.5319,
    description: "カツオのたたきやご当地グルメが集まる人気スポット。",
    open: "10:00",
    close: "22:00",
    closed: [],
    bestTime: "noon",
  },
  {
    id: "sunday-market",
    name: "日曜市",
    tags: ["local", "food"],
    area: "中心部",
    typicalStayMin: 60,
    lat: 33.5595,
    lng: 133.5310,
    description: "約1km続く青空市。野菜・果物・田舎寿司など。",
    onlySunday: true,
    open: "05:00",
    close: "15:00",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "harimaya",
    name: "はりまや橋・商店街",
    tags: ["local", "history"],
    area: "中心部",
    typicalStayMin: 30,
    lat: 33.5598,
    lng: 133.5410,
    description: "高知の象徴的スポット。周辺の商店街も散策に最適。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "afternoon",
  },
  {
    id: "cafe",
    name: "まったりカフェタイム（中心部）",
    tags: ["relax", "local", "food"],
    area: "中心部",
    typicalStayMin: 60,
    lat: 33.5592,
    lng: 133.5350,
    description: "喫茶文化が根付く高知でゆっくり休憩。",
    open: "09:00",
    close: "18:00",
    closed: [],
    bestTime: "afternoon",
  },
  {
    id: "makino",
    name: "高知県立牧野植物園",
    tags: ["nature", "relax"],
    area: "五台山",
    typicalStayMin: 120,
    lat: 33.5598,
    lng: 133.5564,
    description: "牧野富太郎ゆかりの植物園。四季の花が美しい。",
    open: "09:00",
    close: "17:00",
    closed: ["tue"],
    bestTime: "morning",
  },
  {
    id: "godaisan-temple",
    name: "竹林寺（五台山）",
    tags: ["history", "relax"],
    area: "五台山",
    typicalStayMin: 60,
    lat: 33.5587,
    lng: 133.5550,
    description: "四国霊場31番札所。静かな時間を過ごせる寺院。",
    open: "08:00",
    close: "17:00",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "godaisan-view",
    name: "五台山展望台",
    tags: ["nature", "relax"],
    area: "五台山",
    typicalStayMin: 30,
    lat: 33.5608,
    lng: 133.5575,
    description: "高知市街を一望できる絶景スポット。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "afternoon",
  },
  {
    id: "katsurahama",
    name: "桂浜・坂本龍馬像",
    tags: ["nature", "history"],
    area: "桂浜",
    typicalStayMin: 120,
    lat: 33.4964,
    lng: 133.5730,
    description: "太平洋を望む景勝地。龍馬像も人気。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "ryoma-museum",
    name: "高知県立坂本龍馬記念館",
    tags: ["history"],
    area: "桂浜",
    typicalStayMin: 90,
    lat: 33.4978,
    lng: 133.5745,
    description: "龍馬の生涯と幕末史を深く学べる博物館。",
    open: "09:00",
    close: "17:00",
    closed: [],
    bestTime: "afternoon",
  },
  {
    id: "katsurahama-aquarium",
    name: "桂浜水族館",
    tags: ["nature", "local"],
    area: "桂浜",
    typicalStayMin: 60,
    lat: 33.4955,
    lng: 133.5735,
    description: "ローカル感あふれる水族館。動物との距離が近い。",
    open: "09:00",
    close: "17:00",
    closed: [],
    bestTime: "noon",
  },
  {
    id: "asakura",
    name: "朝倉エリア散策（大学周辺）",
    tags: ["local", "relax"],
    area: "郊外",
    typicalStayMin: 60,
    lat: 33.5535,
    lng: 133.5030,
    description: "学生街のカフェや書店が点在する落ち着いたエリア。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "afternoon",
  },
  {
    id: "inari",
    name: "秦神社・稲荷神社",
    tags: ["history", "local"],
    area: "郊外",
    typicalStayMin: 40,
    lat: 33.5530,
    lng: 133.5150,
    description: "地元に愛される神社で静かな時間を。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "tosanosato",
    name: "とさのさと（産直市場）",
    tags: ["food", "local"],
    area: "郊外",
    typicalStayMin: 45,
    lat: 33.5655,
    lng: 133.5465,
    description: "新鮮な野菜や特産品が揃う大型産直。",
    open: "09:00",
    close: "18:00",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "ryugado",
    name: "龍河洞（香美市）",
    tags: ["nature", "history"],
    area: "遠方",
    typicalStayMin: 120,
    lat: 33.6120,
    lng: 133.7020,
    description: "日本三大鍾乳洞のひとつ。探検気分を味わえる。",
    open: "09:00",
    close: "17:00",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "anpanman",
    name: "アンパンマンミュージアム（香美市）",
    tags: ["local", "relax"],
    area: "遠方",
    typicalStayMin: 120,
    lat: 33.5675,
    lng: 133.7025,
    description: "やなせたかしの世界を楽しめるミュージアム。",
    open: "09:30",
    close: "17:00",
    closed: ["tue"],
    bestTime: "afternoon",
  },
  {
    id: "niyodo",
    name: "仁淀川ブルー（いの町）",
    tags: ["nature"],
    area: "遠方",
    typicalStayMin: 120,
    lat: 33.5650,
    lng: 133.3550,
    description: "透明度抜群の清流。川辺散策や写真撮影に最適。",
    open: "00:00",
    close: "23:59",
    closed: [],
    bestTime: "morning",
  },
  {
    id: "tosayama",
    name: "土佐山アクティビティ（温泉・カフェ）",
    tags: ["nature", "relax"],
    area: "遠方",
    typicalStayMin: 120,
    lat: 33.6060,
    lng: 133.4450,
    description: "山間の静かなエリアで自然と温泉を楽しめる。",
    open: "10:00",
    close: "18:00",
    closed: [],
    bestTime: "afternoon",
  },
];

/* =========================================================
   エリア間移動時間
   ========================================================= */
const travelTimeMatrix = {
  "中心部": { "中心部": 10, "五台山": 20, "桂浜": 35, "郊外": 20, "遠方": 50 },
  "五台山": { "中心部": 20, "五台山": 10, "桂浜": 25, "郊外": 30, "遠方": 60 },
  "桂浜": { "中心部": 35, "五台山": 25, "桂浜": 10, "郊外": 40, "遠方": 70 },
  "郊外": { "中心部": 20, "五台山": 30, "桂浜": 40, "郊外": 10, "遠方": 50 },
  "遠方": { "中心部": 50, "五台山": 60, "桂浜": 70, "郊外": 50, "遠方": 20 },
};

/* =========================================================
   ユーティリティ
   ========================================================= */
function parseTimeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}
function minutesToTimeStr(mins) {
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
}
function isSunday(dateStr) {
  if (!dateStr) return false;
  return new Date(dateStr).getDay() === 0;
}

/* =========================================================
   Leaflet 地図
   ========================================================= */
let map = L.map("map").setView([33.5593, 133.5311], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
}).addTo(map);

let markerLayer = L.layerGroup().addTo(map);
let candidateLayer = L.layerGroup().addTo(map);
candidateLayer.clearLayers();

function clearMarkers() {
  markerLayer.clearLayers();
}

function addNumberedMarkers(timeline) {
  clearMarkers();
  const bounds = [];

  timeline.forEach((t, index) => {
    const num = index + 1;
    const icon = L.divIcon({
      className: "",
      html: `<div class="marker-number">${num}</div>`,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
    });

    const marker = L.marker([t.spot.lat, t.spot.lng], { icon }).addTo(markerLayer);

    const gmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${t.spot.lat},${t.spot.lng}`;
    marker.bindPopup(`
      <strong>${num}. ${t.spot.name}</strong><br/>
      ${t.spot.description}<br/>
      <a href="${gmapUrl}" target="_blank">現在地からのルートを見る</a>
    `);

    bounds.push([t.spot.lat, t.spot.lng]);
  });

  if (bounds.length === 1) {
    map.setView(bounds[0], 14);
  } else if (bounds.length > 1) {
    map.fitBounds(bounds, { padding: [30, 30] });
  }
}

/* =========================================================
   現在地表示
   ========================================================= */
let userMarker = null;

document.getElementById("locateBtn").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("位置情報が利用できません");
    return;
  }

  navigator.geolocation.getCurrentPosition((pos) => {
    const { latitude, longitude } = pos.coords;

    if (userMarker) map.removeLayer(userMarker);

    userMarker = L.circleMarker([latitude, longitude], {
      radius: 8,
      color: "#0ea5e9",
      fillColor: "#38bdf8",
      fillOpacity: 0.8,
    }).addTo(map);

    map.setView([latitude, longitude], 14);
  });
});

/* =========================================================
   候補リスト（折り畳み＋検索）
   ========================================================= */
const candidateToggle = document.getElementById("candidateToggle");
const candidateList = document.getElementById("candidateList");
const candidateItems = document.getElementById("candidateItems");
const candidateSearch = document.getElementById("candidateSearch");

candidateToggle.addEventListener("click", () => {
  const isOpen = candidateList.style.display === "block";
  candidateList.style.display = isOpen ? "none" : "block";
  candidateToggle.children[0].textContent = isOpen
    ? "▶ スポット候補一覧"
    : "▼ スポット候補一覧";
});

function renderCandidateList() {
  candidateItems.innerHTML = "";
  const keyword = candidateSearch.value.trim().toLowerCase();

  const filtered = spots.filter((s) =>
    s.name.toLowerCase().includes(keyword)
  );

  document.getElementById("candidateCount").textContent = `（${filtered.length}件）`;

  filtered.forEach((s) => {
    const div = document.createElement("div");
    div.className = "spot-item";
    div.innerHTML = `
      <span>${s.name}</span>
      <button class="spot-add-btn" data-id="${s.id}">＋追加</button>
    `;
    candidateItems.appendChild(div);
  });
}

candidateSearch.addEventListener("input", renderCandidateList);
renderCandidateList();

/* =========================================================
   追加モード（地図に候補ピン表示）
   ========================================================= */
let addMode = false;

document.getElementById("addModeBtn").addEventListener("click", () => {
  addMode = !addMode;
  document.getElementById("addModeBtn").textContent =
    addMode ? "追加モード：ON" : "追加モード：OFF";

  candidateLayer.clearLayers();

  if (addMode) {
    spots.forEach((s) => {
      const marker = L.circleMarker([s.lat, s.lng], {
        radius: 6,
        color: "#f97316",
        fillColor: "#fb923c",
        fillOpacity: 0.8,
      }).addTo(candidateLayer);

      marker.bindPopup(`
        <strong>${s.name}</strong><br/>
        <button onclick="addSpotById('${s.id}')">このスポットを追加</button>
      `);
    });
  }
});

/* =========================================================
   タイムライン（SortableJS）
   ========================================================= */
let timeline = [];

const sortable = new Sortable(document.getElementById("sortableTimeline"), {
  animation: 150,
  onEnd: () => {
    const newOrder = [];
    document.querySelectorAll(".slot").forEach((el) => {
      const id = el.dataset.id;
      const item = timeline.find((t) => t.spot.id === id);
      if (item) newOrder.push(item);
    });
    timeline = newOrder;
    addNumberedMarkers(timeline);
  },
});

/* =========================================================
   スポット追加・削除
   ========================================================= */
function addSpotById(id) {
  const spot = spots.find((s) => s.id === id);
  if (!spot) return;

  timeline.push({
    spot,
    start: 0,
    end: 0,
    moveMin: 0,
  });

  renderTimeline();
  addNumberedMarkers(timeline);
}

function deleteSpot(id) {
  timeline = timeline.filter((t) => t.spot.id !== id);
  renderTimeline();
  addNumberedMarkers(timeline);
}

/* =========================================================
   コース生成ロジック（営業時間・混雑・昼食挿入）
   ========================================================= */
function generateCourse
  <script>
// =========================================================
// コース生成（前半）
// =========================================================
function generateCourse() {
  const date = document.getElementById("date").value;
  const startTime = document.getElementById("startTime").value || "09:00";
  const endTime = document.getElementById("endTime").value || "18:00";
  const vibe = document.getElementById("vibe").value;

  const selectedThemes = [
    ...document.querySelectorAll("#themeChips .chip.active")
  ].map(c => c.dataset.value);

  const transport =
    document.querySelector("#transportChips .chip.active")?.dataset.value || "walk";

  const startMin = parseTimeToMinutes(startTime);
  const endMin = parseTimeToMinutes(endTime);
  const totalAvailable = Math.max(endMin - startMin, 0);

  if (totalAvailable < 120) {
    timeline = [];
    renderTimeline();
    clearMarkers();
    resultMeta.textContent = "時間が短すぎます。";
    return;
  }

  const sunday = isSunday(date);

  // -------------------------------
  // ① 候補スポットのフィルタリング
  // -------------------------------
  let candidates = spots.filter((s) => {
    if (s.onlySunday && !sunday) return false;
    if (transport === "walk" && s.area === "遠方") return false;
    return true;
  });

  // -------------------------------
  // ② 営業時間チェック
  // -------------------------------
  candidates = candidates.filter((s) => {
    const open = parseTimeToMinutes(s.open);
    const close = parseTimeToMinutes(s.close);
    const visitStart = startMin;
    const visitEnd = endMin;

    // 営業時間と全く重ならない場合は除外
    if (visitEnd < open || visitStart > close) return false;

    // 定休日
    const weekday = ["sun","mon","tue","wed","thu","fri","sat"][new Date(date).getDay()];
    if (s.closed.includes(weekday)) return false;

    return true;
  });

  // -------------------------------
  // ③ テーマスコアリング
  // -------------------------------
  const scored = candidates
    .map((s) => {
      let score = 0;

      if (selectedThemes.length === 0) {
        score = 1;
      } else {
        s.tags.forEach((t) => {
          if (selectedThemes.includes(t)) score += 1;
        });
      }

      // ローカル感は少し加点
      if (s.tags.includes("local")) score += 0.3;

      // 混雑時間帯（bestTime）を考慮
      if (s.bestTime === "morning" && startMin < 12 * 60) score += 0.5;
      if (s.bestTime === "noon" && startMin >= 11 * 60 && startMin <= 14 * 60) score += 0.5;
      if (s.bestTime === "afternoon" && startMin >= 13 * 60) score += 0.5;

      return { spot: s, score };
    })
    .filter((s) => s.score > 0)
    .sort((a, b) => b.score - a.score);

  if (scored.length === 0) {
    timeline = [];
    renderTimeline();
    clearMarkers();
    resultMeta.textContent = "条件に合うスポットがありません。";
    return;
  }

  // -------------------------------
  // ④ 目標滞在時間
  // -------------------------------
  let targetMinutes;
  if (vibe === "slow") targetMinutes = totalAvailable * 0.5;
  else if (vibe === "dense") targetMinutes = totalAvailable * 0.9;
  else targetMinutes = totalAvailable * 0.7;

  // -------------------------------
  // ⑤ スポット選定
  // -------------------------------
  const selected = [];
  let usedMinutes = 0;

  for (const { spot } of scored) {
    const stay = spot.typicalStayMin;
    if (usedMinutes + stay > targetMinutes + 45) continue;
    selected.push(spot);
    usedMinutes += stay;
  }

  if (selected.length === 0) {
    selected.push(scored[0].spot);
  }

  // ここから後半へ続く
  // -------------------------------
  // ⑥ 昼食・カフェ自動挿入
  // -------------------------------
  let hasLunch = selected.some((s) => s.tags.includes("food"));
  const lunchTimeStart = 11 * 60;
  const lunchTimeEnd = 14 * 60;

  if (!hasLunch) {
    const lunchSpot = spots.find((s) => s.tags.includes("food") && s.area === "中心部");
    if (lunchSpot) selected.splice(1, 0, lunchSpot);
  }

  // -------------------------------
  // ⑦ 時間割り当て（移動時間含む）
  // -------------------------------
  timeline = [];
  let current = startMin;

  selected.forEach((spot, index) => {
    let moveMin = 0;

    if (index > 0) {
      const prev = selected[index - 1];
      moveMin = travelTimeMatrix[prev.area][spot.area] || 15;
    }

    const start = current + moveMin;
    const end = Math.min(start + spot.typicalStayMin, endMin);

    timeline.push({ spot, start, end, moveMin });
    current = end;
  });

  renderTimeline();
  addNumberedMarkers(timeline);

  resultMeta.textContent = `スポット数：${timeline.length} / 滞在時間：約${(
    timeline.reduce((a, b) => a + (b.end - b.start), 0) / 60
  ).toFixed(1)}時間`;
}
  // =========================================================
// タイムライン描画
// =========================================================
function renderTimeline() {
  const container = document.getElementById("sortableTimeline");
  container.innerHTML = "";

  timeline.forEach((t) => {
    const div = document.createElement("div");
    div.className = "slot";
    div.dataset.id = t.spot.id;

    div.innerHTML = `
      <div><strong>${t.spot.name}</strong></div>
      <div class="time-range">
        ${minutesToTimeStr(t.start)} 〜 ${minutesToTimeStr(t.end)}
        <span class="move-time">（移動 ${t.moveMin}分）</span>
      </div>
      <div class="slot-delete" onclick="deleteSpot('${t.spot.id}')">削除</div>
    `;

    container.appendChild(div);
  });
}

// =========================================================
// 「＋追加」ボタン（候補リスト側）
// =========================================================
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("spot-add-btn")) {
    const id = e.target.dataset.id;
    addSpotById(id);
  }
});

// =========================================================
// テーマ選択（チップの ON/OFF）
// =========================================================
document.querySelectorAll("#themeChips .chip").forEach((chip) => {
  chip.addEventListener("click", () => {
    chip.classList.toggle("active");
  });
});

// =========================================================
// 移動手段（チップの単一選択）
// =========================================================
document.querySelectorAll("#transportChips .chip").forEach((chip) => {
  chip.addEventListener("click", () => {
    document
      .querySelectorAll("#transportChips .chip")
      .forEach((c) => c.classList.remove("active"));
    chip.classList.add("active");
  });
});

// =========================================================
// 「この条件でつくる」ボタン
// =========================================================
document.getElementById("generateBtn").addEventListener("click", () => {
  generateCourse();
});
</script>
